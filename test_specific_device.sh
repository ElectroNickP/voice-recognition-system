#!/bin/bash

# –¢–µ—Å—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
# –ò–ó–ú–ï–ù–ò–¢–ï –ü–ê–†–ê–ú–ï–¢–†–´ –ù–ò–ñ–ï –ü–û–î –í–ê–®–ï –£–°–¢–†–û–ô–°–¢–í–û

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–ò –°–¢–†–û–ö–ò!)
CARD=0          # –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0, 1, 2...)
DEVICE=0        # –ù–æ–º–µ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0, 1, 2...)
ALSA_DEV="plughw:$CARD,$DEVICE"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø–∏—Å–∏
REC_FILE="/tmp/test_device.wav"
REC_SECONDS=3

echo "=== –¢–ï–°–¢ –£–°–¢–†–û–ô–°–¢–í–ê –ú–ò–ö–†–û–§–û–ù–ê ==="
echo "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $ALSA_DEV"
echo "–ö–∞—Ä—Ç–∞: $CARD, –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE"
echo ""

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (–ø–æ–Ω–∏–∂–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ 30%..."
amixer sset Capture 30% 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å"
echo ""

echo "–°–∫–∞–∂–∏—Ç–µ '–ü–†–ò–í–ï–¢ –ú–ò–†' —á–µ—Ç–∫–æ (3 —Å–µ–∫—É–Ω–¥—ã)..."
echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $ALSA_DEV"

# –ó–∞–ø–∏—Å—å —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º
arecord -D "$ALSA_DEV" -q -d $REC_SECONDS -f S16_LE -r 16000 -c 1 "$REC_FILE"

if [ $? -eq 0 ]; then
    echo "‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–∞!"
    echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(ls -lh $REC_FILE | awk '{print $5}')"
    echo ""
    
    echo "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏:"
    paplay "$REC_FILE"
    echo ""
    
    echo "–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Whisper:"
    WHISPER_BIN="./whisper.cpp/build/bin/whisper-cli"
    WHISPER_MODEL="./whisper.cpp/models/ggml-base.bin"
    
    RECOG_TEXT=$($WHISPER_BIN -m $WHISPER_MODEL -l ru -f "$REC_FILE" -otxt -nt 2>/dev/null | sed 's/\[.*\]//g' | xargs)
    echo "–†–µ–∑—É–ª—å—Ç–∞—Ç: '$RECOG_TEXT'"
    
    if [[ "$RECOG_TEXT" == *"–ø—Ä–∏–≤–µ—Ç"* ]] || [[ "$RECOG_TEXT" == *"–º–∏—Ä"* ]]; then
        echo "üéâ –£–°–ü–ï–•: –ì–æ–ª–æ—Å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω!"
    elif [[ -n "$RECOG_TEXT" ]]; then
        echo "‚ö†Ô∏è –†–∞—Å–ø–æ–∑–Ω–∞–Ω —Ç–µ–∫—Å—Ç, –Ω–æ –Ω–µ '–ø—Ä–∏–≤–µ—Ç –º–∏—Ä': '$RECOG_TEXT'"
    else
        echo "‚ùå –ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –Ω–∏—á–µ–≥–æ"
    fi
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    cp "$REC_FILE" "./device_test_card${CARD}_dev${DEVICE}.wav"
    echo "–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: device_test_card${CARD}_dev${DEVICE}.wav"
    
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º $ALSA_DEV"
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è CARD –∏ DEVICE"
fi

# –û—á–∏—Å—Ç–∫–∞
rm -f "$REC_FILE"

echo ""
echo "=== –ò–ù–°–¢–†–£–ö–¶–ò–Ø ==="
echo "–ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏–∑–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è CARD –∏ DEVICE –≤ —Å–∫—Ä–∏–ø—Ç–µ"
echo "–ù–∞–ø—Ä–∏–º–µ—Ä: CARD=1 DEVICE=0 –¥–ª—è plughw:1,0"
echo "–ò–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ: CARD=0 DEVICE=1 –¥–ª—è plughw:0,1" 